rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSuperAdmin() {
      return get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.super_admin == true;
    }

    function getSchoolUserData(schoolId, userId) {
      return get(/databases/$(database)/documents/schools/$(schoolId)/users/$(userId)).data;
    }

    function isSchoolAdmin(schoolId) {
      return exists(/databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid)) &&
             getSchoolUserData(schoolId, request.auth.uid).role == 'school_admin';
    }

    function isCoach(schoolId) {
      return exists(/databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid)) &&
             getSchoolUserData(schoolId, request.auth.uid).role == 'coach';
    }

    function isMemberOfSchool(schoolId) {
      return isSchoolAdmin(schoolId) || isCoach(schoolId);
    }

    function isAssignedToCategory(schoolId, categoryId) {
      return categoryId in getSchoolUserData(schoolId, request.auth.uid).assignedCategories;
    }
    
    // --- Collection Group Functions ---
    // Rule for any read on a collection group, e.g. /schools/{schoolId}/players
    function canReadCollectionGroup(collectionName) {
      // Example: User is trying to read from /schools/sanjuan/players/player123
      // resource.data.__name__[6] will be 'sanjuan' (the schoolId)
      let schoolId = resource.data.__name__[6];
      return isSuperAdmin() || isMemberOfSchool(schoolId);
    }
    
    // --- Global Collections ---
    match /platformUsers/{userId} {
      allow read: if isSuperAdmin() || request.auth.uid == userId;
      allow write: if isSuperAdmin();
    }

    match /schools/{schoolId} {
      allow read: if isSuperAdmin() || isMemberOfSchool(schoolId);
      allow create, update: if isSuperAdmin(); // Only super admins can create/edit school details
      allow delete: if false; // Schools should be soft-deleted by changing status
    }

    // --- School Sub-Collections ---
    
    // School user profiles can be read by any member of the school, but only written by admins.
    match /schools/{schoolId}/users/{userId} {
        allow read: if isSuperAdmin() || isMemberOfSchool(schoolId);
        allow write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
    
    // Categories can be read by any member of the school, but only written by admins.
    match /schools/{schoolId}/categories/{categoryId} {
        allow read: if isSuperAdmin() || isMemberOfSchool(schoolId);
        allow write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
    
    // Player data is the most sensitive.
    match /schools/{schoolId}/players/{playerId} {
      allow read, update: if isSuperAdmin() || isMemberOfSchool(schoolId);
      allow create, delete: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }

    // --- Rules for collections that are not yet implemented in the MVP ---
    // These are placeholders for when trainings and evaluations are added.
    match /schools/{schoolId}/trainings/{trainingId} {
       allow read, write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
    
    match /schools/{schoolId}/evaluations/{evalId} {
       allow read, write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
    
    match /schools/{schoolId}/invites/{inviteId} {
       allow read, write: if isSuperAdmin() || isSchoolAdmin(schoolId);
    }
  }
}
